<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF--8">
    <title>Pitunti Transcoder</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; margin: 0; padding-top: 2rem; }
        h1 { color: #bb86fc; text-transform: uppercase; letter-spacing: 2px; }
        #app-container { background-color: #1e1e1e; border-radius: 12px; padding: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 90%; max-width: 1000px; }
        .selection-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem; }
        @media (min-width: 768px) { .selection-grid { grid-template-columns: repeat(3, 1fr) auto; } }
        .selection-group { display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; font-size: 0.9rem; color: #a0a0a0; }
        select, button { height: 3rem; padding: 0.8rem; border-radius: 6px; border: 1px solid #333; background-color: #2c2c2c; color: #e0e0e0; font-size: 1rem; cursor: pointer; }
        button { background-color: #03dac6; color: #121212; font-weight: bold; border: none; align-self: end; }
        video { width: 100%; border-radius: 8px; background-color: black; display: none; }
        #status { margin-top: 1rem; color: #ffb4ab; height: 1.2rem; }
    </style>
 <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div id="app-container">
        <h1>ðŸš€ Pitunti Transcoder</h1>
        <div class="selection-grid">
            <div class="selection-group">
                <label for="video-selector">Video:</label>
                <select id="video-selector" disabled><option>Cargando...</option></select>
            </div>
            <div class="selection-group">
                <label for="quality-selector">Calidad:</label>
                <select id="quality-selector">
                    <option value="1080p">1080p</option>
                    <option value="720p" selected>720p</option>
                    <option value="480p">480p</option>
                </select>
            </div>
            <div class="selection-group">
                <label for="audio-selector">Audio:</label>
                <select id="audio-selector" disabled><option>-</option></select>
            </div>
            <div class="selection-group">
                <label for="subtitle-selector">SubtÃ­tulos:</label>
                <select id="subtitle-selector" disabled><option>-</option></select>
            </div>
            <button id="load-video-btn">Cargar Video</button>
        </div>
        <video id="video" controls></video>
        <div id="status"></div>
    </div>

    <script>
        const videoSelector = document.getElementById('video-selector');
        const qualitySelector = document.getElementById('quality-selector');
        const audioSelector = document.getElementById('audio-selector');
        const subtitleSelector = document.getElementById('subtitle-selector');
        const loadBtn = document.getElementById('load-video-btn');
        const statusDiv = document.getElementById('status');
        const videoEl = document.getElementById('video');
        let hls = null;

        // Cargar lista de videos
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/videos').then(r => r.json()).then(videos => {
                videoSelector.innerHTML = videos.map(v => `<option value="${v}">${v}</option>`).join('');
                videoSelector.disabled = false;
                videoSelector.dispatchEvent(new Event('change')); // Cargar pistas del primer video
            });
        });

        // Cuando se cambia el video, buscar sus pistas de audio/subtÃ­tulos
        videoSelector.addEventListener('change', () => {
            const videoFile = videoSelector.value;
            if (!videoFile) return;

            audioSelector.innerHTML = '<option>Cargando...</option>';
            subtitleSelector.innerHTML = '<option>Cargando...</option>';
            audioSelector.disabled = true;
            subtitleSelector.disabled = true;

            fetch(`/api/probe/${videoFile}`).then(r => r.json()).then(streams => {
                const audioStreams = streams.filter(s => s.codec_type === 'audio');
                const subtitleStreams = streams.filter(s => s.codec_type === 'subtitle');

                audioSelector.innerHTML = audioStreams.map(s => `<option value="0:a:${s.index-1}">${s.tags?.language || 'Audio ' + s.index}</option>`).join('');
                subtitleSelector.innerHTML = '<option value="">Ninguno</option>' + subtitleStreams.map(s => `<option value="0:s:${s.index-2}">${s.tags?.language || 'Sub ' + s.index}</option>`).join('');
                
                audioSelector.disabled = false;
                subtitleSelector.disabled = false;
            });
        });

        // Al hacer click en "Cargar Video"
        loadBtn.addEventListener('click', () => {
            const params = new URLSearchParams({
                quality: qualitySelector.value,
                audioIndex: audioSelector.value,
                subtitleIndex: subtitleSelector.value
            });
            const url = `/transcode/${videoSelector.value}?${params}`;

            statusDiv.textContent = 'Iniciando transcodificaciÃ³n...';
            videoEl.style.display = 'none';
            if (hls) hls.destroy();

            fetch(url).then(r => r.json()).then(data => {
                if (data.error) throw new Error(data.error);
                statusDiv.textContent = 'Â¡Listo! Cargando video...';
                videoEl.style.display = 'block';
                
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(data.manifestUrl);
                    hls.attachMedia(videoEl);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => videoEl.play());
                } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
                    videoEl.src = data.manifestUrl;
                    videoEl.addEventListener('loadedmetadata', () => videoEl.play());
                }
            }).catch(err => statusDiv.textContent = `Error: ${err.message}`);
        });
    </script>
</body>
</html>